<!DOCTYPE html>
<html lang="en">
  <head>
    <title>EasyEDA 3d export test</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <style>
      b {
        color: lightgreen;
      }

      html {
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <script type="module">
      import * as THREE from "https://cdnjs.cloudflare.com/ajax/libs/three.js/r123/three.module.js";
      import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.123.0/examples/jsm/controls/OrbitControls.js";
      import { OBJLoader2Parallel } from "https://cdn.jsdelivr.net/npm/three@0.123.0/examples/jsm/loaders/OBJLoader2Parallel.js";
      import DataStore from "./DataStore.js";
      import * as DataProcess from "./DataProcess.js";

      let SCREEN_WIDTH = window.innerWidth;
      let SCREEN_HEIGHT = window.innerHeight;
      let aspect = SCREEN_WIDTH / SCREEN_HEIGHT;

      let cube;
      let container;
      let camera, scene, renderer, mesh;
      let cameraRig, activeCamera, activeHelper;
      let cameraPerspective, cameraOrtho;
      let cameraPerspectiveHelper, cameraOrthoHelper;
      const frustumSize = 600;

      let geometries = null;

      // Load 3d-data example file
      // The following command needs to be started :
      //      npx http-server /home/alabate/dev/easyeda-3d-export
      // And the page accessed from http://127.0.0.1:8081/test.html
      const request = new Request("./src-data-example.json");
      fetch(request)
        .then((response) => response.json())
        .then((data) => {
          const datastore = new DataStore(data);

          // Tree js Init
          init(datastore);
          animate();
        });

      function init(datastore) {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x808080);
        camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
        document.body.appendChild(renderer.domElement);

        // Find all BoardOutLine shapes
        const { border, holes } = DataProcess.getBoardOutlinePolygones(
          datastore
        );

        // Create the board shape
        const boardShape = new THREE.Shape(
          border.getCoordinates().map((p) => new THREE.Vector2(p.x, p.y))
        );
        for (const hole of holes) {
          const vectorList = hole
            .getCoordinates()
            .map((p) => new THREE.Vector2(p.x, p.y));
          boardShape.holes.push(new THREE.Path(vectorList));
        }

        const boardGeometry = new THREE.ExtrudeGeometry(boardShape, {
          depth: 1,
          bevelEnabled: false,
        });
        var boardMaterial = new THREE.MeshFaceMaterial([
          // blue surface top and bottom
          new THREE.MeshBasicMaterial({ color: 0x092559 }),
          // yellowish borders
          new THREE.MeshBasicMaterial({ color: 0xafaf68 }),
        ]);
        const boardMesh = new THREE.Mesh(boardGeometry, boardMaterial);
        scene.add(boardMesh);

        // Try to get 3D shapes
        DataProcess.get3dShapes(datastore);
        let objLoader2Parallel = new OBJLoader2Parallel();
        function callbackOnLoad(object3d, message) {
          local.add(object3d);
        }
        objLoader2Parallel.load(
          "https://easyeda.com/analyzer/api/3dmodel/5c06dbf3f43040c4baada5acef156c93?_=1609172673948",
          callbackOnLoad,
          null,
          null,
          null
        );

        // Initial camera position
        const boardCentroid = border.getEnvelope().getCentroid();

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        camera.position.set(boardCentroid.getX(), boardCentroid.getY(), 100);
        controls.target.set(boardCentroid.getX(), boardCentroid.getY(), 0);
        controls.update();
      }

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
