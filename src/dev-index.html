<!DOCTYPE html>
<html lang="en">
  <head>
    <title>EasyEDA 3d export test</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <style>
      b {
        color: lightgreen;
      }

      html {
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <script src="./DataStore.js"></script>
    <script src="./Pcb3D.js"></script>
    <script src="./utilities.js"></script>
    <script type="module">
      const BOARD_THICKNESS = 3;

      const SCREEN_WIDTH = window.innerWidth;
      const SCREEN_HEIGHT = window.innerHeight;

      let renderer, scene, camera;

      // Load js dependencies like in plugin main.js
      const loadJs = window.window.extension3dExporterLoadJs;
      loadJs("https://cdn.jsdelivr.net/npm/jsts@2.6.1/dist/jsts.js")
        .then(() =>
          loadJs(
            "https://cdn.jsdelivr.net/npm/three@0.123.0/build/three.min.js"
          )
        )
        .then(() =>
          loadJs(
            "https://cdn.jsdelivr.net/npm/three@0.123.0/examples/js/loaders/OBJLoader.js"
          )
        )
        .then(() =>
          loadJs(
            "https://cdn.jsdelivr.net/npm/three@0.123.0/examples/js/controls/OrbitControls.js"
          )
        )
        .then(() => {
          // Load 3d-data example file
          // The following command needs to be started :
          //      npx http-server /home/alabate/dev/easyeda-3d-export
          // And the page accessed from http://127.0.0.1:8081/test.html
          const request = new Request("./dev-exemple-src.json");
          fetch(request)
            .then((response) => response.json())
            .then((data) => {
              const datastore = new DataStore(data);

              // Tree js Init
              init(datastore);
              animate();
            });
        });

      function init(datastore) {
        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x808080);

        // Cameras
        camera = new THREE.PerspectiveCamera(
          75,
          SCREEN_WIDTH / SCREEN_HEIGHT,
          0.1,
          1000
        );
        scene.add(camera);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.1));
        camera.add(new THREE.PointLight(0xffffff, 1));

        // Renderer
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
        document.body.appendChild(renderer.domElement);

        // Add PCB to scene
        const pcb3d = new Pcb3D(datastore);
        pcb3d.addToScene(scene);

        // Controls
        const boardCentroid = pcb3d.getPcbBoardCentroid();
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        camera.position.set(boardCentroid.getX(), boardCentroid.getY(), 100);
        controls.target.set(boardCentroid.getX(), boardCentroid.getY(), 0);
        controls.update();
      }

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
